# Stage 1: Build
FROM python:3.13-slim-bookworm AS builder

# Install build tools and ccache
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    ccache \
    clang \
    patchelf \
    && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONPATH="/app" \
    UV_LINK_MODE=copy \
    UV_COMPILE_BYTECODE=1 \
    UV_NO_CACHE=1 \
    PYTHONUNBUFFERED=1 \
    # Nuitka & CCache Configuration
    NUITKA_CACHE_DIR=/root/.cache/Nuitka \
    CCACHE_DIR=/root/.cache/ccache

WORKDIR /app

COPY pyproject.toml uv.lock ./
COPY src src

# Cache Mount 1: Cache uv dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-editable

ENV CFLAGS="-Wno-macro-redefined"

# Cache Mount 2: Cache Nuitka and C Compiler artifacts
# This is the critical change for speed
RUN --mount=type=cache,target=/root/.cache/Nuitka \
    --mount=type=cache,target=/root/.cache/ccache \
    uv run python -m nuitka \
    --standalone \
    --clang \
    --python-flag=nosite,-O \
    --prefer-source-code \
    --output-dir=/app/build \
    --output-filename=dependency_cmp \
    src/dependency_cmp/main.py

# Stage 2: Runtime (Unchanged from your original)
FROM debian:bookworm-slim

COPY --from=k8s.gcr.io/kustomize/kustomize:v5.8.0 /app/kustomize /usr/local/bin/kustomize
COPY --from=builder /app/build/main.dist /opt/dependency_cmp
RUN ln -s /opt/dependency_cmp/dependency_cmp /usr/local/bin/dependency_cmp

USER 999
WORKDIR /app

COPY --chown=999:999 plugin.yaml /home/argocd/cmp-server/config/plugin.yaml

ENTRYPOINT ["/var/run/argocd/argocd-cmp-server"]